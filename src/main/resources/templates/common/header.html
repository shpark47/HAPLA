<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="topbar">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/css/header.css" rel="stylesheet" type="text/css">
</head>
<body>
<header class="header">
    <div class="logo-section">
        <span class="hapla-logo" onclick="location.href='/main'">HAPLA</span>
    </div>
    <div class="user-section">
        <label th:hidden="${session.loginUser != null}" id="login">ë¡œê·¸ì¸</label>
        <img th:src="@{${session.loginUser != null ? session.loginUser.profile : ''}}" alt="User Profile" class="user-profile" id="user-profile-image" th:hidden="${session.loginUser == null}">
        <div class="dropdown">
            <a onclick="openModal()">ë‚´ ì •ë³´</a>
            <a href="/comm/list">ì»¤ë®¤ë‹ˆí‹°</a>
            <a href="#">ì—¬í–‰ì§€ì¶”ì²œ</a>
            <a onclick="openCitySearchModal()">ì—¬í–‰ ì¼ì •</a>
            <a href="/review/main">ë¦¬ë·° ì‘ì„±</a>
            <a href="#">ë¬¸ì˜í•˜ê¸°</a>
            <a href="/users/logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</header>

<div class="header-modal hidden" role="dialog" id="editModal" align="center">
    <div class="header-modal-div">
        <button class="header-close-btn" aria-label="ë‹«ê¸°" onclick="closeModal()"></button>
        <div class="header-banner">HAPLA</div>
        <form class="edit-form">
            <div class="profile-image-container">
                <img th:src="@{${session.loginUser != null ? session.loginUser.profile : ''}}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-image" id="profileImage">
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button type="button" class="image-upload-btn" onclick="document.getElementById('imageUpload').click()">
                    í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½
                </button>
            </div>

            <label for="nickname" class="header-modal-label">ë‹‰ë„¤ì„:</label>
            <input type="text" id="nickname" name="nickname" class="header-modal-input" th:value="${session.loginUser != null ? session.loginUser.nickname : ''}" required>

            <button id="save" class="header-modal-button" type="submit">ë³€ê²½ì‚¬í•­ ì €ì¥</button>

            <button type="button" class="delete-account-btn">íšŒì› íƒˆí‡´í•˜ê¸°</button>
        </form>
    </div>
</div>
<div class="header-modal hidden" role="dialog" id="joinModal" align="center">
    <div class="header-modal-div">
        <button class="header-close-btn" aria-label="ë‹«ê¸°"></button>
        <div class="header-banner">HAPLA</div>
        <form class="header-modal-form" id="joinForm">
            <input type="hidden" id="loginType" name="type">
            <input type="hidden" id="tokenId" name="tokenId">
            <input type="hidden" id="profile" name="profile">

            <img src="" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-image" id="loginImage">

            <label for="nickname" class="header-modal-label">ì´ë¦„:</label>
            <input type="text" id="loginName" name="name" class="modal-input" readonly>

            <label for="nickname" class="header-modal-label">ë‹‰ë„¤ì„:</label>
            <input type="text" id="nickname" name="nickname" class="modal-input" required>

            <label for="email" class="header-modal-label">ì´ë©”ì¼:</label>
            <input type="email" id="email" name="email" class="modal-input" required>

            <button id="joinBtn" class="header-modal-button" type="button">ê°€ì…í•˜ê¸°</button>
        </form>
    </div>
</div>

<div class="header-modal hidden" role="dialog" id="loginModal" align="center">
    <div class="header-modal-div">
        <button class="header-close-btn" aria-label="ë‹«ê¸°"></button>
        <h1 class="login-title">HAPLA</h1>
        <p class="login-subtitle">ì˜ˆì •ë¶€í„° ì¼ì •ê¹Œì§€ ì—¬í–‰ì´ ë” ì‰¬ì›Œì§‘ë‹ˆë‹¤</p>

        <button id="google-login-btn" class="login-btn" style="background: white"></button>
        <button id="kakao-login-btn" class="login-btn"><img src="/img/kakao.png" alt=""></button>
    </div>

    <!-- Kakao SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

    <!-- Google SDK -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="/js/login.js"></script>
    <script src="/js/join.js"></script>
</div>
</body>
<script src="/js/header.js"></script>

<!-- ğŸŒ ë„ì‹œ ê²€ìƒ‰ ëª¨ë‹¬ -->
<div id="citySearchModal" class="modal-trip">
    <div class="modal-content">
        <span class="close" onclick="closeCitySearchModal()">&times;</span>
        <h2>ë„ì‹œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</h2>
        <input type="text" id="searchInput" placeholder="ë„ì‹œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”..." oninput="filterCities()">
        <ul id="cityList"></ul>
    </div>
</div>

<script>
    //ğŸŒ ëª¨ë‹¬ ì—´ê¸°
    function openCitySearchModal() {
        document.getElementById("citySearchModal").style.display = "block";
    }

    // âŒ ëª¨ë‹¬ ë‹«ê¸°
    function closeCitySearchModal() {
        document.getElementById("citySearchModal").style.display = "none";
    }

    // ğŸŒ REST Countries APIì—ì„œ ìˆ˜ë„(ë„ì‹œ) ê²€ìƒ‰
    let cities = [];

    async function fetchCities() {
        try {
            const response = await fetch("https://restcountries.com/v3.1/all");
            const data = await response.json();
            cities = data.map(country => ({
                name: country.capital ? country.capital[0] : "",
                country: country.translations.kor?.common || country.name.common
            })).filter(city => city.name); // ìˆ˜ë„ê°€ ì—†ëŠ” ê²½ìš° ì œê±°
        } catch (error) {
            console.error("ë„ì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    fetchCities(); // APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

    // ğŸ” ë„ì‹œ ê²€ìƒ‰ ê¸°ëŠ¥
    function filterCities() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const filteredCities = cities.filter(city =>
            city.name.toLowerCase().includes(searchTerm) ||
            city.country.toLowerCase().includes(searchTerm)
        );

        displayCities(filteredCities);
    }

    // ğŸŒ† ê²€ìƒ‰ëœ ë„ì‹œ ëª©ë¡ í‘œì‹œ
    function displayCities(cityArray) {
        const cityList = document.getElementById("cityList");
        cityList.innerHTML = "";

        cityArray.forEach(city => {
            const li = document.createElement("li");
            li.textContent = `${city.name}, ${city.country}`;
            li.onclick = function () {
                selectCity(city);
            };
            cityList.appendChild(li);
        });
    }

    // âœ… ë„ì‹œ ì„ íƒ í›„ ì¼ì • í˜ì´ì§€ë¡œ ì´ë™
    function selectCity(city) {
        localStorage.setItem("selectedCity", JSON.stringify(city));
        window.location.href = "/scheduleCalendar.html";
    }
</script>
</html>