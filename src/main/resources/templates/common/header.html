<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="topbar">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/css/header.css" rel="stylesheet" type="text/css">
</head>
<body>
<header class="header">
    <div class="logo-section">
        <span class="hapla-logo" onclick="location.href='/main'">HAPLA</span>
    </div>
    <div class="user-section">
        <label th:hidden="${session.loginUser != null}" id="login">로그인</label>
        <img th:src="@{${session.loginUser != null ? session.loginUser.profile : ''}}" alt="User Profile" class="user-profile" id="user-profile-image" th:hidden="${session.loginUser == null}">
        <div class="header-dropdown">
            <a onclick="openModal()">내 정보</a>
            <a href="/comm/list">커뮤니티</a>
            <a href="#">여행지추천</a>
            <a onclick="openCitySearchModal()">여행 일정</a>
            <a href="/review/main">리뷰 작성</a>
            <a href="#">문의하기</a>
            <a href="/users/logout">로그아웃</a>
        </div>
    </div>
</header>

<div class="header-modal hidden" role="dialog" id="editModal" align="center">
    <div class="header-modal-div">
        <button class="header-close-btn" aria-label="닫기" onclick="closeModal()"></button>
        <div class="header-banner">HAPLA</div>
        <form class="edit-form">
            <div class="profile-image-container">
                <input type="hidden" name="profile" id="profileImg">
                <img th:src="@{${session.loginUser != null ? session.loginUser.profile : '/img/시나모롤.jpg'}}"
                     alt="프로필 이미지" class="profile-image" id="profileImage">
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button type="button" class="image-upload-btn" onclick="document.getElementById('imageUpload').click()">
                    프로필 사진 변경
                </button>
            </div>

            <label for="nickname" class="header-modal-label">닉네임:</label>
            <input type="text" id="nickname" name="nickname" class="header-modal-input"
                   th:value="${session.loginUser != null ? session.loginUser.nickname : ''}" required>

            <button id="save" class="header-modal-button" type="button">변경사항 저장</button>
            <button type="button" class="delete-account-btn">회원 탈퇴하기</button>
        </form>
    </div>
</div>

<div class="header-modal hidden" role="dialog" id="joinModal" align="center">
    <div class="header-modal-div">
        <button class="header-close-btn" aria-label="닫기"></button>
        <div class="header-banner">HAPLA</div>
        <form class="header-modal-form" id="joinForm">
            <input type="hidden" id="loginType" name="type">
            <input type="hidden" id="tokenId" name="tokenId">
            <input type="hidden" id="profile" name="profile">

            <img src="" alt="프로필 이미지" class="profile-image" id="loginImage">

            <label for="nickname" class="header-modal-label">이름:</label>
            <input type="text" id="loginName" name="name" class="modal-input" readonly>

            <label for="nickname" class="header-modal-label">닉네임:</label>
            <input type="text" id="nickname" name="nickname" class="modal-input" required>

            <label for="email" class="header-modal-label">이메일:</label>
            <input type="email" id="email" name="email" class="modal-input" required>

            <button id="joinBtn" class="header-modal-button" type="button">가입하기</button>
        </form>
    </div>
</div>

<div class="header-modal hidden" role="dialog" id="loginModal" align="center">
    <div class="header-modal-div">
        <button class="header-close-btn" aria-label="닫기"></button>
        <h1 class="login-title">HAPLA</h1>
        <p class="login-subtitle">예정부터 일정까지 여행이 더 쉬워집니다</p>

        <button id="google-login-btn" class="login-btn" style="background: white"></button>
        <button id="kakao-login-btn" class="login-btn"><img src="/img/kakao.png" alt=""></button>
    </div>

    <!-- Kakao SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

    <!-- Google SDK -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="/js/login.js"></script>
    <script src="/js/join.js"></script>
</div>
</body>
<script src="/js/header.js"></script>

<!-- 도시 검색 모달 -->
<div id="citySearchModal" class="modal-trip">
    <div class="modal-content">

        <!-- <span class="close" onclick="closeCitySearchModal()">&times;</span> -->

        <!-- 검색 입력창 -->
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="도시 이름을 입력하세요..." oninput="filterCities()">
            <span class="search-icon">
            	<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>
            </span>
        </div>

        <!-- 검색 결과 리스트 -->
        <ul id="cityList"></ul>
    </div>
</div>

<script>
    //🌍 모달 열기
    function openCitySearchModal() {
        document.getElementById("citySearchModal").style.display = "block";
        filterCities();
    }

    // ❌ 모달 닫기
    function closeCitySearchModal() {
        document.getElementById("citySearchModal").style.display = "none";
    }

    // 🖱️ 모달 외부 클릭 시 닫기
    window.addEventListener("click", function(event) {
        const modal = document.getElementById("citySearchModal");
        if (event.target === modal) {
            closeCitySearchModal();
        }
    });

    // 🌍 REST Countries API에서 수도(도시) 검색
    let cities = [];

    async function fetchCities() {
        try {
            const response = await fetch("https://restcountries.com/v3.1/all");
            const data = await response.json();
            cities = data.map(country => ({
                name: country.capital ? country.capital[0] : "",
                // name: country.capital ? country.capital[0] : country.capital,
                country: country.translations.kor?.common || country.name.common
            })).filter(city => city.name); // 수도가 없는 경우 제거
        } catch (error) {
            console.error("도시 데이터를 불러오는 중 오류 발생:", error);
        }
    }

    fetchCities(); // API에서 데이터 가져오기

    // 🔍 도시 검색 기능
    function filterCities() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const filteredCities = cities.filter(city =>
            city.name.toLowerCase().includes(searchTerm) ||
            city.country.toLowerCase().includes(searchTerm)
        );

        displayCities(filteredCities);
    }

    // 🌆 검색된 도시 목록 표시
    function displayCities(cityArray) {
        const cityList = document.getElementById("cityList");
        cityList.innerHTML = "";

        cityArray.forEach(city => {
            const li = document.createElement("li");

            // 📍 아이콘 추가
            const icon = document.createElement("span");
            icon.classList.add("city-icon");
            icon.textContent = "📍";

            // 🌍 도시 이름
            const cityName = document.createElement("span");
            cityName.textContent = city.name;
            cityName.style.fontWeight = "bold";
            cityName.style.marginRight = "10px";

            // 🌎 국가 이름
            const countryName = document.createElement("span");
            countryName.classList.add("country-name");
            countryName.textContent = city.country;

            li.appendChild(icon);
            li.appendChild(cityName);
            li.appendChild(countryName);

            li.onclick = function () {
                selectCity(city);
            };
            cityList.appendChild(li);
        });
    }


    // ✅ 도시 선택 시 실행되는 함수 (도시 정보 저장 & 페이지 이동)
    function selectCity(city) {
        const cityData = {
            name: city.name, // 도시명
            country: city.country, // 국가명
            lat: city.lat, // 위도
            lng: city.lng // 경도
        };

        // ✅ 선택한 도시 정보를 localStorage에 저장 (일정 페이지에서 사용)
        localStorage.setItem("selectedCity", JSON.stringify(cityData));

        // ✅ 일정 페이지로 이동
        window.location.href = "/schedule/scheduleCalendar";
    }

    // ✅ API에서 도시 리스트 가져올 때 위도(lat), 경도(lng) 정보 포함
    async function fetchCities() {
        try {
            const response = await fetch("https://restcountries.com/v3.1/all");
            const data = await response.json();

            cities = data.map(country => ({
                name: country.capital ? country.capital[0] : "", // 수도
                country: country.translations.kor?.common || country.name.common, // 국가명 (한국어)
                lat: country.latlng ? country.latlng[0] : null, // 위도
                lng: country.latlng ? country.latlng[1] : null // 경도
            })).filter(city => city.name && city.lat !== null && city.lng !== null); // 데이터 없는 항목 필터링
        } catch (error) {
            console.error("도시 데이터를 불러오는 중 오류 발생:", error);
        }
    }

    // ✅ 실행: API에서 도시 정보 가져오기
    fetchCities();

</script>
</html>