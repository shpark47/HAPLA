<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAPLA Travel</title>
    <link href="/css/main.css" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
</head>
<body>
<div th:replace="~{common/header.html :: topbar}"></div>
<main>
    <section th:replace="~{common/search.html :: search}"></section>
    <section class="popular-destinations">
        <h2>인기 여행지</h2>
        <div class="destinations-grid">
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>제주도</h3>
                    <p>아름다운 자연과 문화의 섬</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>부산</h3>
                    <p>해변도시의 매력</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>서울</h3>
                    <p>현대와 전통이 공존하는 도시</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>경주</h3>
                    <p>천년고도의 역사</p>
                </div>
            </div>
        </div>
    </section>
    <section class="popular-destinations">
        <h2>인기 여행지</h2>
        <div class="destinations-grid">
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>제주도</h3>
                    <p>아름다운 자연과 문화의 섬</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>부산</h3>
                    <p>해변도시의 매력</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>서울</h3>
                    <p>현대와 전통이 공존하는 도시</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>경주</h3>
                    <p>천년고도의 역사</p>
                </div>
            </div>
        </div>
    </section>
    <section class="popular-destinations">
        <h2>인기 여행지</h2>
        <div class="destinations-grid">
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>제주도</h3>
                    <p>아름다운 자연과 문화의 섬</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>부산</h3>
                    <p>해변도시의 매력</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>서울</h3>
                    <p>현대와 전통이 공존하는 도시</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>경주</h3>
                    <p>천년고도의 역사</p>
                </div>
            </div>
        </div>
    </section>
    <section class="popular-destinations">
        <h2>인기 여행지</h2>
        <div class="destinations-grid">
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>제주도</h3>
                    <p>아름다운 자연과 문화의 섬</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>부산</h3>
                    <p>해변도시의 매력</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>서울</h3>
                    <p>현대와 전통이 공존하는 도시</p>
                </div>
            </div>
            <div class="destination-card">
                <img src="/img/시나모롤.jpg" alt="Destination">
                <div class="destination-info">
                    <h3>경주</h3>
                    <p>천년고도의 역사</p>
                </div>
            </div>
        </div>
    </section>
</main>
<div th:replace="~{common/footer.html :: foot}"></div>

<div class="modal hidden" role="dialog" id="joinModal" align="center">
    <div class="modal-div">
        <button class="close-btn" aria-label="닫기"></button>
        <div class="banner">HAPLA</div>
        <form class="modal-form">
            <input type="hidden" id="loginType" name="type">
            <img src="" alt="프로필 이미지" class="profile-image" id="loginImage">

            <label for="nickname" class="modal-label">이름:</label>
            <input type="text" id="loginName" name="name" class="modal-input" readonly>

            <label for="nickname" class="modal-label">닉네임:</label>
            <input type="text" id="nickname" name="nickname" class="modal-input" required>

            <label for="email" class="modal-label">이메일:</label>
            <input type="email" id="email" name="email" class="modal-input" required>

            <button id="join" class="modal-button" type="submit">가입하기</button>
        </form>
    </div>
</div>

<div class="modal hidden" role="dialog" id="loginModal" align="center">
    <div class="modal-div">
        <button class="close-btn" aria-label="닫기"></button>
        <h1 class="login-title">HAPLA</h1>
        <p class="login-subtitle">예정부터 일정까지 여행이 더 쉬워집니다</p>

        <button id="google-login-btn" class="login-btn" style="background: white"></button>
        <button id="kakao-login-btn" class="login-btn"><img src="/img/kakao.png" alt=""></button>
    </div>

    <!-- Kakao SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

    <!-- Google SDK -->
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        let loginImage = '';
        let loginName = '';
        let loginType = '';

        // ✅ 카카오 SDK 초기화
        Kakao.init("04cff7eb62f268a2bb506c81bf1de17b");

        // ✅ 카카오 로그인 버튼 클릭 시 실행
        document.getElementById("kakao-login-btn").addEventListener("click", function () {
            Kakao.Auth.login({
                scope: "profile_nickname, profile_image",
                success: function (authObj) {
                    console.log("✅ 로그인 성공! 액세스 토큰:", authObj.access_token);

                    // ✅ 액세스 토큰을 이용하여 사용자 정보 가져오기
                    fetchUserInfo(authObj.access_token);
                },
                fail: function (err) {
                    console.error("❌ 로그인 실패", err);
                },
            });
        });

        // ✅ 사용자 정보 가져와서 모달 업데이트
        function fetchUserInfo(accessToken) {
            Kakao.API.request({
                url: "/v2/user/me",
                success: function (response) {
                    console.log("✅ 사용자 정보:", response);
                    console.log(response.id)

                    checkUser(response.id, "K");

                    loginImage = response.properties.profile_image;
                    loginName = response.properties.nickname;
                    loginType = "K";

                    // 🔹 프로필 정보 모달에 적용
                    updateModal(loginImage, loginName, loginType);

                    // 🔹 액세스 토큰 & 사용자 정보 저장
                    localStorage.setItem("accessToken", accessToken);
                    localStorage.setItem("userInfo", JSON.stringify(response));
                },
                fail: function (error) {
                    console.error("❌ 사용자 정보 가져오기 실패", error);
                },
            });
        }

        // ✅ 모달창 업데이트 (프로필 이미지 & 닉네임)
        function updateModal(loginImage, loginName, loginType) {
            const modal = document.getElementById("joinModal");
            const profileImage = document.getElementById("loginImage");
            const nicknameInput = document.getElementById("loginName");
            const type = document.getElementById("loginType");

            // 🔹 사용자 정보 적용
            profileImage.src = loginImage;
            nicknameInput.value = loginName || "사용자";
            type.value = loginType;

            // 🔹 모달창 표시
            document.getElementById('loginModal').classList.add('hidden');
            modal.classList.remove("hidden");
        }

        // Google 로그인 버튼
        google.accounts.id.initialize({
            client_id: '157461561471-a5mi8bhvlq4rt4ci11j6ep6h8ftd6tmq.apps.googleusercontent.com',
            callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
            document.getElementById("google-login-btn"),
            {theme: "outline", size: "large", width: "100%"}
        );

        function handleCredentialResponse(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            fetchUserProfile(response.credential);
        }

        // 사용자 프로필 정보 가져오기
        function fetchUserProfile(token) {
            fetch('http://localhost:8080/google-login/verify-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token: token })  // JWT 토큰을 서버로 전송
            })
                .then(response => response.json())
                .then(data => {
                    checkUser(data.userId, "G");

                    loginImage = data.picture;
                    loginName = data.name;
                    loginType = "G";
                    updateModal(loginImage, loginName, loginType);
                })
                .catch(error => {
                    console.error('Error fetching user profile:', error);
                });
        }

        const checkUser = (id, type) => {

        }
    </script>
</div>

<div class="modal hidden" role="dialog" id="editModal" align="center">
    <div class="modal-div">
        <button class="close-btn" aria-label="닫기" onclick="closeModal()"></button>
        <div class="banner">HAPLA</div>
        <form class="edit-form">
            <div class="profile-image-container">
                <img src="/img/시나모롤.jpg" alt="프로필 이미지" class="profile-image" id="profileImage">
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button type="button" class="image-upload-btn" onclick="document.getElementById('imageUpload').click()">
                    프로필 사진 변경
                </button>
            </div>

            <label for="nickname" class="modal-label">닉네임:</label>
            <input type="text" id="nickname" name="nickname" class="modal-input" required>

            <button id="save" class="modal-button" type="submit">변경사항 저장</button>

            <button type="button" class="delete-account-btn">회원 탈퇴하기</button>
        </form>
    </div>
</div>

<script src="/js/main.js"></script>
</body>
</html>